---
title: "Homework 3"
output: github_document
---

```{r}
library(tidyverse)
```


## Problem 1
### Load, tidy, merge, and otherwise organize the data sets. Your final dataset should include all originally observed variables; exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).

Cleaning and combining data sets
```{r}
demographic_df = 
  read_csv("datasets/nhanes_covar.csv",na = c("NA",".",""), skip = 4)|>
  janitor::clean_names() |>
  filter(age >= 21)

accelerometer_df = 
  read_csv("datasets/nhanes_accel.csv",na = c("NA",".",""))|>
  janitor::clean_names() |>
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "activity value"
  )
```

```{r}
cleaned_df = 
  demographic_df |>
  inner_join(accelerometer_df, by=c("seqn"))|>
  filter(!is.na(sex) & !is.na(bmi) & !is.na(education) & !is.na(age)) |>
  mutate(
    sex = ifelse(sex == 1, "male", "female"),
    education = case_when(
      education == 1 ~ "Less than high school",
      education == 2 ~ "High school equivalent",
      education == 3 ~ "More than high school"
  ))
head(cleaned_df)
```


### Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.
```{r}
sex_edu_table = 
  cleaned_df |>
  group_by(sex,education) |>
  mutate(
    education = as.factor(education),
    sex = as.factor(sex)
  ) |>
  summarise(count = n()) |>
  arrange(sex,education)

print(sex_edu_table)
```

```{r}
age_distribution_plot = 
  cleaned_df |>
  ggplot(aes(x = age, fill = sex)) +
  geom_histogram(binwidth = 3) +
  facet_wrap(~education) +
  labs(title = "Age Distribution by Gender and Eduaction", 
       x = "Age",
       y = "Count")
print(age_distribution_plot)
```

comment:

### Traditional analyses of accelerometer data focus on the total activity over the day. Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.

```{r}
total_activity_df = 
  cleaned_df |>
  group_by(seqn, sex, age, education) |>
  summarise(total_activity = sum(`activity value`, na.rm = TRUE))

total_activity_df |>
  ggplot(aes(x = age, y = total_activity,color = sex)) +
  geom_point(alpha = .2)+
  geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~education) +
  labs(title = "Total Activity",
       x = "Age",
       y = "Total Activity",
       color = "Gender") +
  theme_minimal()
```

### Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.
```{r}
activity_time_df = 
  cleaned_df |>
  group_by(sex,education, minute)|>
  summarise(ave_activity = mean(`activity value`, na.rm = TRUE))

```

```{r}
activity_time_df |>
  ggplot(aes(x = minute, y = ave_activity, color = sex))+
  geom_point(alpha = .2) +
  facet_wrap(~education) + 
  labs(title = "24-Hour Activity Time Courses by Education Level and Gender",
       x = "Time (Minute)",
       y = "Average Activity Level",
       color = "Gender") +
  theme_minimal()
```

Description:



## Q3
### Read datasets first
```{r}
jan_2020_citi_df = 
  read_csv("citibike/Jan 2020 Citi.csv", na = c("NA",".","")) |>
  janitor::clean_names()
  
july_2020_citi_df = 
  read_csv("citibike/July 2020 Citi.csv", na = c("NA",".",""))|>
  janitor::clean_names()

jan_2024_citi_df = 
  read_csv("citibike/Jan 2024 Citi.csv", na=c("NA",".",""))|>
  janitor::clean_names()

july_2024_citi_df = 
  read_csv("citibike/July 2024 Citi.csv",na=c("NA",".",""))|>
  janitor::clean_names()
```

```{r}
jan_2020_citi_df =
  jan_2020_citi_df |>
  mutate(year = 2020, month = "January")

july_2020_citi_df = 
  july_2020_citi_df |>
  mutate(year = 2020, month = "July")

jan_2024_citi_df = 
  jan_2024_citi_df |>
  mutate(year = 2024, month = "January")

july_2024_citi_df = 
  july_2024_citi_df |>
  mutate(year = 2024, month = "July")
```

```{r}
citi_all_df = 
  bind_rows(jan_2020_citi_df,july_2020_citi_df,jan_2024_citi_df,july_2024_citi_df) |>
  filter(!is.na(start_station_name)&!is.na(end_station_name)) |>
  mutate(weekdays = factor(weekdays, 
                           levels = c(
                            "Monday", 
                            "Tuesday", 
                            "Wednesday", 
                            "Thursday", 
                            "Friday", 
                            "Saturday", 
                            "Sunday"),
                           ordered = TRUE)) |>
  arrange(weekdays)
```

Description:
the tidy citi data set includes `r nrow(citi_all_df)` observations, and `r ncol(citi_all_df)` variables. Key variables includes riders' id, bike's type, the day they used, duration, the start station's name and end stattion's name, as well as whether they are member of citi. I combined four individual data sets by users' id, and remove all missing data in start station and end station. I also re-arrange the weekdays variable, by preseting from Monday to Sunday. 

### Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.

```{r}

ride_summary = 
  citi_all_df |>
  group_by(year, month,member_casual)|>
  summarise(total_rides = n())
```

Description:
the reader-friendly table includes `r nrow(ride_summary)` observations, and `r ncol(ride_summary)` variables. We can see that there were more members using citi than casual users in 2020 Jan to 2024 Jan. The total use of causal and member in 2024 July both increased a lot. We can see an increased demand on citi in NYC. 

### Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.
```{r}
top_station =
  july_2024_citi_df |>
  group_by(start_station_name)|>
  summarise(total_rides = n()) |>
  arrange(desc(total_rides))|>
  slice(1:5)
```

###Make a plot to investigate the effects of day of the week, month, and year on median ride duration. This plot can include one or more panels, but should facilitate comparison across all variables of interest. Comment on your observations from this plot.
```{r}
median_duration = 
  citi_all_df |>
  group_by(year, month, weekdays)|>
  summarise(median_duration = median(duration)) 
```

```{r}
  ggplot(median_duration, aes(x = weekdays, y = median_duration, fill = weekdays))+
  geom_col(position = "dodge") +
    facet_grid(year~month) +
    labs(title = "Median Duration Distribution by Year Month Weekdays",
         x = "Weedays",
         y = "Median Duration")
```
Comments:
In both 2020 and 2024, rides in July generally have longer median durations compared to January. This may relate to weather. July is warmer than January. In July 2020, there is an increase ride duration on weekends. People have more leisure time to use citi bike. In July 2020, the duration is higher than other three months. 


###There were relatively few electric Citi Bikes in 2020, but many more are available now. For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.
```{r}
ride_2024 =
  bind_rows(jan_2024_citi_df, july_2024_citi_df) |>
  ggplot(aes(x = rideable_type, y = duration, fill = member_casual))+
  geom_violin(scale = "width") +
  facet_grid(month ~ member_casual) +  
  labs(title = "Distribution of Ride Duration by Bike Type, Month, and Membership Status (2024)",
       x = "Bike Type",
       y = "Ride Duration",
       fill = "Membership Status")
ride_2024
```
Comment:
We can see that casual riders tend to have longer duration than member riders because the spread looks wider than member riders. Classic bikes tend to have wider spread in casual riders, but same spread in member riders. In January, the use of classic bike is higher than electric bike both for casual riders and member rider. However, the use of two bikes are almost same in July. 








